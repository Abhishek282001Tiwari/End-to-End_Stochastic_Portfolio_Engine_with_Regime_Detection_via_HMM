<!-- Site monitoring and error tracking -->

<!-- Error tracking and reporting -->
<script>
// Global error handler
window.addEventListener('error', function(e) {
  const errorData = {
    message: e.message,
    filename: e.filename,
    lineno: e.lineno,
    colno: e.colno,
    stack: e.error ? e.error.stack : 'No stack trace',
    userAgent: navigator.userAgent,
    url: window.location.href,
    timestamp: new Date().toISOString()
  };
  
  // Log to console for debugging
  console.error('Global error caught:', errorData);
  
  // Send to analytics if available
  if (typeof gtag !== 'undefined') {
    gtag('event', 'exception', {
      description: errorData.message,
      fatal: false,
      custom_parameter: JSON.stringify(errorData)
    });
  }
  
  // Send to external monitoring service if configured
  if (window.errorTracker) {
    window.errorTracker.captureException(errorData);
  }
});

// Promise rejection handler
window.addEventListener('unhandledrejection', function(e) {
  const errorData = {
    reason: e.reason,
    promise: e.promise,
    url: window.location.href,
    timestamp: new Date().toISOString()
  };
  
  console.error('Unhandled promise rejection:', errorData);
  
  if (typeof gtag !== 'undefined') {
    gtag('event', 'exception', {
      description: 'Unhandled Promise Rejection: ' + e.reason,
      fatal: false,
      custom_parameter: JSON.stringify(errorData)
    });
  }
});

// Network error monitoring
function monitorNetworkErrors() {
  // Monitor failed resource loads
  window.addEventListener('error', function(e) {
    if (e.target !== window) {
      const errorData = {
        type: 'resource_error',
        element: e.target.tagName,
        source: e.target.src || e.target.href,
        message: 'Failed to load resource',
        timestamp: new Date().toISOString()
      };
      
      console.warn('Resource load error:', errorData);
      
      if (typeof gtag !== 'undefined') {
        gtag('event', 'resource_error', {
          event_category: 'performance',
          event_label: errorData.source,
          transport_type: 'beacon'
        });
      }
    }
  }, true);
  
  // Monitor fetch failures
  const originalFetch = window.fetch;
  window.fetch = function(...args) {
    return originalFetch.apply(this, args).catch(error => {
      console.error('Fetch error:', error);
      
      if (typeof gtag !== 'undefined') {
        gtag('event', 'fetch_error', {
          event_category: 'network',
          event_label: args[0],
          transport_type: 'beacon'
        });
      }
      
      throw error;
    });
  };
}

// Initialize network monitoring
monitorNetworkErrors();
</script>

<!-- Performance monitoring -->
<script>
// Page load performance monitoring
window.addEventListener('load', function() {
  // Use setTimeout to ensure all resources are loaded
  setTimeout(function() {
    if ('performance' in window && 'timing' in performance) {
      const timing = performance.timing;
      const metrics = {
        dns_lookup: timing.domainLookupEnd - timing.domainLookupStart,
        tcp_connect: timing.connectEnd - timing.connectStart,
        ssl_handshake: timing.secureConnectionStart > 0 ? 
          timing.connectEnd - timing.secureConnectionStart : 0,
        server_response: timing.responseStart - timing.requestStart,
        dom_processing: timing.domComplete - timing.domLoading,
        page_load: timing.loadEventEnd - timing.navigationStart,
        first_byte: timing.responseStart - timing.navigationStart,
        dom_ready: timing.domContentLoadedEventEnd - timing.navigationStart
      };
      
      // Send performance metrics to analytics
      if (typeof gtag !== 'undefined') {
        Object.entries(metrics).forEach(([metric, value]) => {
          if (value > 0) {
            gtag('event', 'timing_complete', {
              name: metric,
              value: Math.round(value),
              event_category: 'performance'
            });
          }
        });
      }
      
      // Log performance summary
      console.log('Performance metrics:', metrics);
      
      // Check for performance issues
      if (metrics.page_load > 3000) {
        console.warn('Slow page load detected:', metrics.page_load + 'ms');
      }
      
      if (metrics.first_byte > 1000) {
        console.warn('Slow server response detected:', metrics.first_byte + 'ms');
      }
    }
  }, 0);
});

// Memory usage monitoring (if available)
function monitorMemoryUsage() {
  if ('memory' in performance) {
    const memory = performance.memory;
    const memoryInfo = {
      used: memory.usedJSHeapSize,
      total: memory.totalJSHeapSize,
      limit: memory.jsHeapSizeLimit,
      percentage: Math.round((memory.usedJSHeapSize / memory.jsHeapSizeLimit) * 100)
    };
    
    // Warn if memory usage is high
    if (memoryInfo.percentage > 80) {
      console.warn('High memory usage detected:', memoryInfo);
      
      if (typeof gtag !== 'undefined') {
        gtag('event', 'memory_warning', {
          event_category: 'performance',
          event_label: 'high_memory_usage',
          value: memoryInfo.percentage
        });
      }
    }
    
    return memoryInfo;
  }
  return null;
}

// Check memory usage periodically
setInterval(monitorMemoryUsage, 30000); // Every 30 seconds
</script>

<!-- Accessibility monitoring -->
<script>
// Basic accessibility monitoring
function monitorAccessibility() {
  // Check for images without alt text
  const imagesWithoutAlt = document.querySelectorAll('img:not([alt])');
  if (imagesWithoutAlt.length > 0) {
    console.warn('Images without alt text found:', imagesWithoutAlt.length);
    
    if (typeof gtag !== 'undefined') {
      gtag('event', 'accessibility_issue', {
        event_category: 'quality',
        event_label: 'missing_alt_text',
        value: imagesWithoutAlt.length
      });
    }
  }
  
  // Check for form inputs without labels
  const inputsWithoutLabels = document.querySelectorAll('input:not([aria-label]):not([aria-labelledby])');
  const unlabeledInputs = Array.from(inputsWithoutLabels).filter(input => {
    const label = document.querySelector(`label[for="${input.id}"]`);
    return !label && input.type !== 'hidden' && input.type !== 'submit';
  });
  
  if (unlabeledInputs.length > 0) {
    console.warn('Form inputs without labels found:', unlabeledInputs.length);
    
    if (typeof gtag !== 'undefined') {
      gtag('event', 'accessibility_issue', {
        event_category: 'quality',
        event_label: 'missing_labels',
        value: unlabeledInputs.length
      });
    }
  }
  
  // Check for focus management
  let lastFocusedElement = null;
  document.addEventListener('focusin', function(e) {
    lastFocusedElement = e.target;
  });
  
  // Monitor tab traps
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Tab' && !e.shiftKey) {
      setTimeout(() => {
        if (document.activeElement === lastFocusedElement) {
          console.warn('Potential focus trap detected');
        }
      }, 10);
    }
  });
}

// Run accessibility monitoring when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', monitorAccessibility);
} else {
  monitorAccessibility();
}
</script>

<!-- Chart.js error monitoring -->
<script>
// Monitor Chart.js errors if Chart.js is loaded
window.addEventListener('load', function() {
  if (typeof Chart !== 'undefined') {
    // Override Chart.js error handling
    const originalOnError = Chart.defaults.onError || function() {};
    Chart.defaults.onError = function(chart, error) {
      console.error('Chart.js error:', error);
      
      if (typeof gtag !== 'undefined') {
        gtag('event', 'chart_error', {
          event_category: 'visualization',
          event_label: error.message || 'Unknown chart error',
          transport_type: 'beacon'
        });
      }
      
      // Call original error handler
      originalOnError.call(this, chart, error);
    };
    
    // Monitor successful chart renders
    Chart.defaults.onResize = function(chart) {
      if (typeof gtag !== 'undefined') {
        gtag('event', 'chart_resize', {
          event_category: 'visualization',
          event_label: chart.config.type,
          transport_type: 'beacon'
        });
      }
    };
  }
});
</script>

<!-- Uptime monitoring heartbeat -->
<script>
// Send periodic heartbeat for uptime monitoring
function sendHeartbeat() {
  const heartbeatData = {
    timestamp: new Date().toISOString(),
    page: window.location.pathname,
    performance: performance.now(),
    online: navigator.onLine
  };
  
  // Send heartbeat to monitoring service
  if (typeof gtag !== 'undefined') {
    gtag('event', 'heartbeat', {
      event_category: 'monitoring',
      event_label: 'site_health',
      custom_parameter: JSON.stringify(heartbeatData),
      transport_type: 'beacon'
    });
  }
}

// Send heartbeat every 5 minutes
setInterval(sendHeartbeat, 5 * 60 * 1000);

// Send heartbeat on page visibility change
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) {
    sendHeartbeat();
  }
});
</script>

<!-- Real User Monitoring (RUM) -->
<script>
// Collect real user monitoring data
class RealUserMonitoring {
  constructor() {
    this.metrics = {};
    this.collectBasicMetrics();
    this.setupObservers();
  }
  
  collectBasicMetrics() {
    // Browser and device info
    this.metrics.browser = {
      userAgent: navigator.userAgent,
      language: navigator.language,
      platform: navigator.platform,
      cookieEnabled: navigator.cookieEnabled,
      onLine: navigator.onLine
    };
    
    // Screen and viewport info
    this.metrics.viewport = {
      screenWidth: screen.width,
      screenHeight: screen.height,
      windowWidth: window.innerWidth,
      windowHeight: window.innerHeight,
      devicePixelRatio: window.devicePixelRatio || 1
    };
    
    // Connection info (if available)
    if ('connection' in navigator) {
      this.metrics.connection = {
        effectiveType: navigator.connection.effectiveType,
        downlink: navigator.connection.downlink,
        rtt: navigator.connection.rtt,
        saveData: navigator.connection.saveData
      };
    }
  }
  
  setupObservers() {
    // Observe performance entries
    if ('PerformanceObserver' in window) {
      try {
        const observer = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            this.processPerformanceEntry(entry);
          }
        });
        
        observer.observe({ entryTypes: ['navigation', 'resource', 'measure', 'mark'] });
      } catch (e) {
        console.warn('PerformanceObserver not supported or error:', e);
      }
    }
  }
  
  processPerformanceEntry(entry) {
    if (entry.entryType === 'navigation') {
      this.metrics.navigation = {
        type: entry.type,
        domContentLoaded: entry.domContentLoadedEventEnd - entry.domContentLoadedEventStart,
        loadComplete: entry.loadEventEnd - entry.loadEventStart,
        transferSize: entry.transferSize,
        encodedBodySize: entry.encodedBodySize
      };
    }
  }
  
  sendMetrics() {
    if (typeof gtag !== 'undefined') {
      gtag('event', 'rum_data', {
        event_category: 'monitoring',
        event_label: 'real_user_metrics',
        custom_parameter: JSON.stringify(this.metrics),
        transport_type: 'beacon'
      });
    }
  }
}

// Initialize RUM
const rum = new RealUserMonitoring();

// Send RUM data when page is about to unload
window.addEventListener('beforeunload', () => {
  rum.sendMetrics();
});
</script>